language: php
php:
  - 5.3
services:
  - mysql
before_install:
  - COMMIT=`git log -n 1 2>/dev/null | grep "commit " | cut -c7-`
  - BRANCH=`git branch -r --contains $COMMIT 2>/dev/null | cut -c10-`
  - git submodule update --init --recursive
  - git clone git://github.com/novius-os/ci.git
  - cd ci
  - git checkout $BRANCH
  - cd ..
  - sudo sh -c 'cat /etc/apt/source.list'
  - sudo apt-get install -y --force-yes apache2 libapache2-mod-php5 php5-mysql php5-sqlite
  - sudo a2enmod rewrite
  - cat ci/virtualhost | sed -e "s,PATH,`pwd`/public,g" | sudo tee /etc/apache2/sites-available/default > /dev/null
  - sudo service apache2 reload
  - sudo sh -c 'echo "127.0.0.1 novius-os" >> /etc/hosts'
  - chmod a+w local/config
  - chmod a+w local/data/
  - chmod a+w local/metadata
  - chmod a+w public/
  - ln -s ../../novius-os/htdocs public/htdocs/novius-os
  - mkdir public/htdocs/apps
  - chmod a+w public/htdocs/apps
  - ln -s ../../novius-os/static public/static/novius-os
  - mkdir public/static/apps
  - chmod a+w public/static/apps
  - mkdir -p logs/fuel
  - chmod a+w logs/fuel
  - mkdir local/cache
  - chmod a+w local/cache
  - chmod a+w local/data/media
before_script:
  - pyrus install pear/PHP_CodeSniffer
  - phpenv rehash
  - mysql -e 'CREATE DATABASE novius_os DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;'
  - "export PHANTOMJS_EXECUTABLE='phantomjs --local-to-remote-url-access=yes --ignore-ssl-errors=yes'"
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
script:
  - "DISPLAY=:99.0 ./ci/casperjs/bin/casperjs test --direct --log-level=info ./ci/tests/ 'http://novius-os/'"
  - phpcs -p -s -n --standard=ci/phpcs/ruleset.xml ./
after_script:
  - sudo sh -c 'cat /var/log/apache2/error.log'
