/*
 *
 * Wijmo Library 2.0.0b2
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijcompositechart",a.wijmo.wijchartcore,{options:{stacked:false,clusterOverlap:0,clusterWidth:85,clusterRadius:0,clusterSpacing:0,seriesList:[],animation:{enabled:true,duration:400,easing:">"},seriesTransition:{enabled:true,duration:400,easing:">"},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_create:function(){var b=this,c=b.options,d=b._getDefFill();a.each(c.seriesList,function(d,b){if(b.type==="bar"){a.extend(true,c.axis,{x:{compass:"west"},y:{compass:"south"}});return true}else if(b.type==="pie"&&b.pieSeriesList)b.data=b.pieSeriesList});a.extend(true,{compass:"east"},c.hint);a.each(c.seriesStyles,function(b,a){if(!a.fill)a.fill=d[b]});a.wijmo.wijchartcore.prototype._create.apply(b,arguments);b.chartElement.addClass("wijmo-wijcompositechart")},destroy:function(){var e=this,c=e.chartElement,d=c.data("fields"),b=d&&d.bars;c.removeClass("wijmo-wijcompositechart");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);b&&b.length&&a.each(b,function(b,a){a=null});c.data("fields",null)},_isBarChart:function(){return true},getElement:function(f,b,c){var d=this.chartElement,e=d.data("fields"),a=e.chartElements;switch(f){case"bar":case"column":return a.bars[b];case"line":return a.paths[b];case"linemarkers":return a.markersSet[b];case"pie":return this._getPie(a,b,c)}return null},_getPie:function(b,e,d){if(d!==undefined)return b["sectors"+d]?b["sectors"+d][e]:null;else{var c=[];a.each(b,function(b,d){/sectors/.test(b)&&b!=="sectors"&&a.each(d,function(b,a){c.push(a)})});if(c.length===0)c=b.sectors;return c[e]}},_isSeriesDataEmpty:function(){var c=this,b=c.options.seriesList;if(!b||b.length===0)return true;a.each(b,function(b,a){return a.type==="pie"&&(!a.data||!a.label||a.label.length===0)?true:!a.data||(!a.data.x||!a.data.y)&&!a.data.xy?true:void 0});return false},_showSerieEles:function(d){var f=d.type,b=d.eles,e=this.options.showChartLabels,c;switch(f){case"pie":if(b.sector){b.sector.show();b.sector.shadow&&b.sector.shadow.show();b.sector.tracker&&b.sector.tracker.show()}b.label&&b.label.show();break;case"line":case"spline":case"bezier":b.markers&&a.each(b.markers,function(d,b){c=a(b.node).data("wijchartDataObj");if(c&&c.lineSeries&&c.lineSeries.markers)if(!c.lineSeries.markers.visible)return true;b.show()});b.dcl&&a.each(b.dcl,function(b,a){e&&a.show()});if(b.path){c=a(b.path.node).data("wijchartDataObj");if(c.visible||c.display==="show"){b.path.show();b.path.shadow&&b.path.shadow.show();b.path.area&&b.path.area.show();b.path.tracker&&b.path.tracker.hide()}}break;case"bar":case"column":a.each(b,function(b,a){if(a.bar){a.bar.show();a.bar.shadow&&a.bar.shadow.show();a.bar.tracker&&a.bar.tracker.show()}a.dcl&&a.dcl.show();a.animatedBar&&a.animatedBar.show()});break;case"scatter":a.each(b,function(b,a){a.show()})}},_hideSerieEles:function(c){var d=c.type,b=c.eles;switch(d){case"pie":if(b.sector){b.sector.hide();b.sector.shadow&&b.sector.shadow.hide();b.sector.tracker&&b.sector.tracker.hide()}b.label&&b.label.hide();break;case"line":case"spline":case"bezier":b.markers&&a.each(b.markers,function(b,a){a.hide()});b.dcl&&a.each(b.dcl,function(b,a){a.hide()});if(b.path){b.path.hide();b.path.shadow&&b.path.shadow.hide();b.path.area&&b.path.area.hide();b.path.tracker&&b.path.tracker.hide()}break;case"bar":case"column":a.each(b,function(b,a){if(a.bar){a.bar.hide();a.bar.shadow&&a.bar.shadow.hide();a.bar.tracker&&a.bar.tracker.hide()}a.dcl&&a.dcl.hide();a.animatedBar&&a.animatedBar.hide()});break;case"scatter":a.each(b,function(b,a){a.hide()})}},_paintTooltip:function(){var b=this,d=b.chartElement,e=d.data("fields"),c=e.ctracers||[];a.wijmo.wijchartcore.prototype._paintTooltip.apply(this,arguments);b.tooltip&&a.each(c,function(c,a){if(a.trackers&&a.trackers.length)c===0&&b.tooltip.setOptions({relatedElement:a.trackers[0]})})},_paintPlotArea:function(){var b=this,c=b.options,g="seriesList",f="seriesStyles",e="seriesHoverStyles",p=c[f],n=c[e],i=b.canvasBounds,m={},h=0,k={canvas:b.canvas,tooltip:b.tooltip,bounds:i,widgetName:b.widgetName,seriesTransition:c.seriesTransition,showChartLabels:c.showChartLabels,textStyle:c.textStyle,chartLabelStyle:c.chartLabelStyle,chartLabelFormatString:c.chartLabelFormatString,shadow:c.shadow,hint:c.hint,animation:c.animation,disabled:c.disabled,mouseDown:function(c,a){b._trigger("mouseDown",c,a)},mouseUp:function(c,a){b._trigger("mouseUp",c,a)},mouseOver:function(c,a){b._trigger("mouseOver",c,a)},mouseOut:function(c,a){b._trigger("mouseOut",c,a)},mouseMove:function(c,a){b._trigger("mouseMove",c,a)},click:function(c,a){b._trigger("click",c,a)}},d,o,j,l;a.each(c[g],function(q,i){var j=i.type,b={},k=j,d={},o=p[h],l=n[h];if(!j||j.length===0)return true;if(k==="spline"||k==="bezier")k="line";b=m[k];if(!b){if(j==="pie")b=[];else b={};m[k]=b;if(i.hint){b.hint=i.hint;if(!c.hint.content)c.hint.content=i.hint.content;if(!c.hint.title)c.hint.title=i.hint.title}}if(j==="pie"){a.each(i.data,function(b,a){o=p[h];l=n[h];if(!d[g])d[g]=[];if(!d[f])d[f]=[];if(!d[e])d[e]=[];a.pieID=q+1;d[g].push(a);d[f].push(o);d[e].push(l);h++});d.radius=i.radius;d.center=i.center;d.label=i.label;b.push(d);return true}else if(j==="column")b.horizontal=false;else if(j==="bar")b.horizontal=true;else if(j==="spline")i.fitType="spline";else if(j==="bezier")i.fitType="bezier";if(j==="line"||j==="spline"||j==="bezier"){delete o.fill;delete l.fill}if(!b[g])b[g]=[];if(!b[f])b[f]=[];if(!b[e])b[e]=[];b[g].push(i);b[f].push(o);b[e].push(l);h++});a.each(m,function(f,e){switch(f){case"pie":a.each(e,function(h,f){var e=f.center,c=f.radius||50,g=e?{startX:e.x-c,startY:e.y-c,endX:e.x+c,endY:e.y+c}:{startX:i.startX+10,startY:i.startY+10,endX:i.startX+10+2*c,endY:i.startY+10+2*c};d=a.extend(true,{},k,{bounds:g,radius:c},f);b.chartElement.wijpie(d)});break;case"bar":case"column":d=a.extend(true,{},k,{stacked:c.stacked,axis:c.axis,clusterOverlap:c.clusterOverlap,clusterWidth:c.clusterWidth,clusterSpacing:c.clusterSpacing,is100Percent:c.is100Percent,clusterRadius:c.clusterRadius,isYTime:b.axisInfo.y.isTime,isXTime:b.axisInfo.x.isTime},e);b.chartElement.wijbar(d);break;case"line":case"spline":case"bezier":if(!b.aniPathsAttr)b.aniPathsAttr=[];d=a.extend(true,{},k,{axis:c.axis,isXTime:b.axisInfo.x.isTime,isYTime:b.axisInfo.y.isTime,aniPathsAttr:b.aniPathsAttr,chartLabelEles:b.chartLabelEles},e);b.chartElement.wijline(d);break;case"scatter":d=a.extend(true,{},k,{axis:c.axis,isXTime:b.axisInfo.x.isTime,isYTime:b.axisInfo.y.isTime,zoomOnHover:c.zoomOnHover},e);b.chartElement.wijscatter(d)}j=b.chartElement.data("fields");o=j.seriesEles;a.each(o,function(c,a){b.seriesEles.push({eles:a,type:f})});l=j.ctracers||[];l.push({trackers:j.trackers,type:f});j.ctracers=l});b.chartElement.data("fields").seriesEles=null;b._bindtooltip()},_bindtooltip:function(){var b=this,c=b.widgetName,d=b.chartElement.data("fields");a.each(d.ctracers,function(b,a){a.trackers&&a.trackers.toFront()});b.chartElement.delegate(".linetracker, .bartracker, .pietracker, .wijscatterchart","mouseover."+c,a.proxy(b._tooltipMouseOver,b));b.chartElement.delegate(".linetracker, .bartracker, .pietracker, .wijscatterchart","mouseout."+c,a.proxy(b._tooltipMouseOut,b));b.chartElement.delegate(".linetracker, .bartracker, .pietracker, .wijscatterchart","mousemove."+c,a.proxy(b._tooltipMouseMove,b))},_tooltipMouseOver:function(f){var d=f.target,b=this,n=b.tooltip,m=b.options.hint,e=null,l=m.title,k=m.content,j=a.isFunction(l),i=a.isFunction(k),c,g,h;h=a(b.canvas.canvas.parentNode).offset();if(a(d).data("owner"))d=a(d).data("owner");d=a(d);c=d.data("wijchartDataObj");if(b.tooltip){e=n.getOptions();if(j||i){if(j)e.title=a.proxy(l,c);if(i)e.content=a.proxy(k,c)}if(c.type==="line"){if(c.path.removed)return;if(b.hoverLine!==c){b.isNewLine=true;if(b.hoverLine)if(!b.hoverLine.path.removed){b.hoverLine.path.wijAttr(b.hoverLine.lineStyle);if(b.hoverPoint&&!b.hoverPoint.isSymbol){b.hoverPoint.marker.wijAttr(b.hoverPoint.markerStyle);b.hoverPoint.marker.transform("s1")}}c.lineHoverStyle&&c.path.wijAttr(c.lineHoverStyle);b.hoverLine=c;b.hoverPoint=null}}else if(c.type==="scatter"){b._clearHoverState();g=c.dot.getBBox();e.style.stroke=d.attr("stroke");b.tooltip.showAt({x:g.x+g.width/2,y:g.y},f)}else{b._clearHoverState();e.style.stroke=d.attr("stroke");b.tooltip.showAt({x:f.pageX-h.left,y:f.pageY-h.top},f)}}},_tooltipMouseMove:function(c){var e=this,b=c.target,d,f=a(e.canvas.canvas.parentNode).offset();if(a(b).data("owner"))b=a(b).data("owner");b=a(b);d=b.data("wijchartDataObj");if(e.tooltip)d.type!=="line"&&d.type!=="scatter"&&e.tooltip.showAt({x:c.pageX-f.left,y:c.pageY-f.top},c)},_tooltipMouseOut:function(e){var d=this,b=e.target,c;if(a(b).data("owner"))b=a(b).data("owner");b=a(b);c=b.data("wijchartDataObj");if(c.type!=="line")d.tooltip&&d.tooltip.hide()},_mouseMoveInsidePlotArea:function(t,s){var b=this,f=b.tooltip,h=b.options.hint,g,d=0,l,e,j,k,r=null,c=null,i=null,q=h.title,p=h.content,n=a.isFunction(q),m=a.isFunction(p),o=0;if(f)i=f.getOptions();if(b.hoverLine){if(b.isNewLine){h.enable&&f&&f.hide();b.isNewLine=false}g=b.hoverLine.lineMarkers;d=-1;l={x:0,y:0};a.each(g,function(f,b){if(b.removed)return true;var a=b.wijGetBBox(),e=a.x+a.width/2,c=Math.abs(e-s.left);if(f===0||c<o){o=c;d=f;l={x:e,y:a.y+a.height/2}}});if(b.hoverPoint&&b.hoverPoint.index===d)return;if(d>-1){if(g[d].removed)return;e=a(g[d].node).data("wijchartDataObj");if(e){if(b.hoverPoint&&!b.hoverPoint.isSymbol)if(!b.hoverPoint.removed){b.hoverPoint.marker.wijAttr(b.hoverPoint.markerStyle);b.hoverPoint.marker.transform("s1")}if(!e.isSymbol)!e.marker.removed&&e.marker.wijAttr(e.markerHoverStyle)}b.hoverPoint=e}if(f){c=b.hoverPoint;j=c.valX;k=c.valY;if(n||m){if(n)i.title=function(){var b={pointIndex:d,lineIndex:c.lineSeries.index,x:j,y:k,label:c.lineSeries.label,data:c,fmt:q},e=a.proxy(b.fmt,b),f=e();return f};if(m)i.content=function(){var b={pointIndex:d,lineIndex:c.lineSeries.index,x:j,y:k,label:c.lineSeries.label,data:c,fmt:p},f=a.proxy(b.fmt,b),e=f();return e}}r=a.extend({stroke:b.hoverLine.path.attr("stroke")},h.style);i.style.stroke=r.stroke;f.showAt(l)}}a.wijmo.wijchartcore.prototype._mouseMoveInsidePlotArea.apply(b,arguments)},_mouseMoveOutsidePlotArea:function(){var b=this;b._clearHoverState();a.wijmo.wijchartcore.prototype._mouseMoveOutsidePlotArea.apply(b,arguments)},_clearHoverState:function(){var a=this,b=a.tooltip,c=a.options.hint;c.enable&&b&&b.hide();if(a.hoverLine)if(!a.hoverLine.path.removed){a.hoverLine.path.wijAttr(a.hoverLine.lineStyle);if(a.hoverPoint&&!a.hoverPoint.isSymbol){a.hoverPoint.marker.wijAttr(a.hoverPoint.markerStyle);a.hoverPoint.marker.transform("s1")}}a.hoverLine=null;a.hoverPoint=null},_getTooltipText:function(){return""},_calculateParameters:function(d,g){var e=this,f=false,c,b;a.wijmo.wijchartcore.prototype._calculateParameters.apply(e,arguments);a.each(e.options.seriesList,function(b,a){if(a.type==="column"||a.type==="bar"){f=true;return false}});if(!f)return;if(d.id==="x"){c=g.unitMinor;b=e._getBarAdjustment(d);if(b===0)b=c;else if(c<b&&c!==0)b=Math.floor(b/c)*c;d.min-=b;d.max+=b;e._calculateMajorMinor(g,d)}},_getBarAdjustment:function(d){var b=0,g=this.options,f=d.max,c=d.min,e=0;a.each(g.seriesList,function(c,a){if(a.type==="pie")return true;e=a.data.x.length;if(b<e)b=e});if(b>1)return(f-c)/b*g.clusterWidth*.0125;else if(b===1){if(c===0&&f===1){c=-1;d.min=c}return(f-c)*.0125}else return 0}})})(jQuery);