/*
 *
 * Wijmo Library 2.0.0b2
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the Wijmo Commercial or GNU GPL Version 3 licenses.
 * licensing@wijmo.com
 * http://wijmo.com/license
 *
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijbarchart",a.wijmo.wijchartcore,{options:{horizontal:true,stacked:false,is100Percent:false,clusterOverlap:0,clusterWidth:85,clusterRadius:0,clusterSpacing:0,animation:{enabled:true,duration:400,easing:">"},seriesTransition:{enabled:true,duration:400,easing:">"},mouseDown:null,mouseUp:null,mouseOver:null,mouseOut:null,mouseMove:null,click:null},_create:function(){var b=this,c=b.options,d=b._getDefFill();c.horizontal&&a.extend(true,c.axis,{x:{compass:"west"},y:{compass:"south"}});a.extend(true,{compass:"east"},c.hint);a.each(c.seriesStyles,function(b,a){if(!a.fill)a.fill=d[b]});a.wijmo.wijchartcore.prototype._create.apply(b,arguments);b.chartElement.addClass("wijmo-wijbarchart")},_setOption:function(c,b){c==="horizontal"&&!b&&a.extend(true,this.options.axis,{x:{compass:"south"},y:{compass:"west"}});a.wijmo.wijchartcore.prototype._setOption.apply(this,arguments)},destroy:function(){var e=this,c=e.chartElement,d=c.data("fields"),b=d&&d.bars;c.removeClass("wijmo-wijbarchart");a.wijmo.wijchartcore.prototype.destroy.apply(this,arguments);b&&b.length&&a.each(b,function(b,a){a=null});c.data("fields",null)},_isBarChart:function(){return true},getBar:function(c){var a=this.chartElement,b=a.data("fields");return b.chartElements.bars[c]},_paintTooltip:function(){var c=this,d=c.chartElement,b=d.data("fields");a.wijmo.wijchartcore.prototype._paintTooltip.apply(this,arguments);if(c.tooltip)if(b&&b.trackers&&b.trackers.length){c.tooltip.setTargets(b.trackers);c.tooltip.setOptions({relatedElement:b.trackers[0]})}},_getTooltipText:function(e,d){var c=a(d.node),b,f;if(c.data("owner"))c=c.data("owner");b=c.data("wijchartDataObj");f={data:b,value:b.value,label:b.label,total:b.total,target:d,fmt:e,x:b.x,y:b.y};return a.proxy(e,f)()},_paintPlotArea:function(){var b=this,c=b.options;b.chartElement.wijbar({canvas:b.canvas,bounds:b.canvasBounds,tooltip:b.tooltip,widgetName:b.widgetName,horizontal:c.horizontal,stacked:c.stacked,axis:c.axis,seriesList:c.seriesList,seriesStyles:c.seriesStyles,seriesHoverStyles:c.seriesHoverStyles,seriesTransition:c.seriesTransition,showChartLabels:c.showChartLabels,textStyle:c.textStyle,chartLabelStyle:c.chartLabelStyle,chartLabelFormatString:c.chartLabelFormatString,shadow:c.shadow,disabled:c.disabled,clusterOverlap:c.clusterOverlap,clusterWidth:c.clusterWidth,clusterSpacing:c.clusterSpacing,is100Percent:c.is100Percent,clusterRadius:c.clusterRadius,animation:c.animation,isYTime:b.axisInfo.y.isTime,isXTime:b.axisInfo.x.isTime,mouseDown:a.proxy(b._mouseDown,b),mouseUp:a.proxy(b._mouseUp,b),mouseOver:a.proxy(b._mouseOver,b),mouseOut:a.proxy(b._mouseOut,b),mouseMove:a.proxy(b._mouseMove,b),click:a.proxy(b._click,b)})},_showSerieEles:function(b){a.each(b,function(b,a){if(a.bar){a.bar.show();a.bar.shadow&&a.bar.shadow.show();a.bar.tracker&&a.bar.tracker.show()}a.dcl&&a.dcl.show();a.animatedBar&&a.animatedBar.show()})},_hideSerieEles:function(b){a.each(b,function(b,a){if(a.bar){a.bar.hide();a.bar.shadow&&a.bar.shadow.hide();a.bar.tracker&&a.bar.tracker.hide()}a.dcl&&a.dcl.hide();a.animatedBar&&a.animatedBar.hide()})},_calculateParameters:function(c,e){a.wijmo.wijchartcore.prototype._calculateParameters.apply(this,arguments);if(c.id==="x"){var d=e.unitMinor,b=this._getBarAdjustment(c);if(b===0)b=d;else if(d<b&&d!==0)b=Math.floor(b/d)*d;c.min-=b;c.max+=b;this._calculateMajorMinor(e,c)}},_getBarAdjustment:function(c){for(var a=0,h=this.options,e=c.max,b=c.min,g=h.seriesList,f=0,d=0,f=0;f<g.length;f++){d=g[f].data.x.length;if(a<d)a=d}if(a>1)return(e-b)/a*h.clusterWidth*.0125;else if(a===1){if(b===0&&e===1){b=-1;c.min=b}return(e-b)*.0125}else return 0}});a.fn.extend({wijbar:function(b){var D=function(c,d,e){b.shadow&&a.wijchart.paintShadow(c,d,e)},t=a.wijraphael.addClass,E=a.wijchart.getScaling,A=a.wijchart.getTranslation,d=this,e=b.canvas,i=b.widgetName,c=b.horizontal,k=b.stacked,s=[].concat(b.seriesList),u=s.length,C=[].concat(b.seriesStyles.slice(0,u)),z=[].concat(b.seriesHoverStyles.slice(0,u)),r=b.bounds,q=b.animation,I=q&&q.enabled,o={x:r.startX,y:r.startY},y=r.endX-o.x,v=r.endY-o.y,l=b.axis.x,m=b.axis.y,j=b.disabled,F=b.mouseDown,K=b.mouseUp,H=b.mouseOver,J=b.mouseOut,G=b.mouseMove,M=b.click,L=b.tooltip,w=E(c,l.max,l.min,c?v:y),x=E(!c,m.max,m.min,c?y:v),N=A(c,o,l.max,l.min,w),O=A(!c,o,m.max,m.min,x),f=d.data("fields")||{},n=f.chartElements||{},h=f.aniBarsAttr,g,Z=b.isYTime,Y=b.isXTime;function W(d){for(var a=Number.MAX_VALUE,e=d.length,c,b=1;b<e;b++){c=d[b].x-d[b-1].x;if(c<a&&c>0)a=c}return a===Number.MAX_VALUE?2:a}function V(b){a.each(b,function(b,a){a.stackValues()});return b}function B(f){var b=[],d=a.wijchart.getXSortedPoints;function c(c){var b=this;b.x=c;b.paSpec=[];b.stackValues=function(){var d=b.paSpec.length,c;if(d>1){c=b.paSpec[0];a.each(b.paSpec,function(b,a){if(b===0)return true;a.y+=c.y;c=a})}}}function e(n,m){var h=d(m),l=m.length,f=null,o=0,e=0,g=0,k=true,i=0,j=false;if(h)o=h.length;if(b)g=b.length;a.each(h,function(d,a){if(k){k=false;i=a.x}else{if(i===a.x)j=true;else j=false;i=a.x}while(e<g&&b[e].x<a.x)e++;if(e<g)if(b[e].x!==a.x){f=new c(a.x,l);b.splice(e,0,f);g=b.length}else f=b[e];else{f=new c(a.x,l);b.push(f);g=b.length}f.paSpec.push({y:a.y,sIdx:n,pIdx:d,dupl:j})})}a.each(f,function(b,a){e(b,a)});return b}function p(a,c,b){return a<c?c:a>b?b:a}function R(c,d,e,f,g,b){a.each(b,function(j,a){var h=a.x,i=a.y,b=0;a.x=d*h+f;a.y=e*i+g;if(c){b=a.x;a.x=a.y;a.y=b}});return b}function P(d,n,m,l){var i=a.extend(true,{},b.textStyle,b.chartLabelStyle),h=c?{x:d.x+d.width,y:d.y+d.height/2}:{x:d.x+d.width/2,y:d.y},k=b.chartLabelFormatString,j,f,g=n;if(l)i=a.extend(true,i,l);if(m)g=a.fromOADate(n);if(k&&k.length)g=Globalize.format(g,b.chartLabelFormatString);else if(!m)g=a.round(g,2);f=e.text(h.x,h.y,g).attr(i);t(a(f.node),"wijbarchart-label");j=f.getBBox();if(c)f.attr({x:h.x+j.width/2});else f.attr({y:h.y-j.height/2});return f}function X(g,A,O,t,u,r,G,E,C,L,n,B,N,K){var M=b.is100Percent,x=t.min,w=t.max,z=u.min,y=u.max,S=t.scale,T=t.late,H=u.scale,J=u.late,v,d,F,f,s=null,j,I=r,m=r["stroke-width"],Q=r.stroke,i,o,l,h,q=-1;if(b.axis.y.origin!==null)q=H*b.axis.y.origin+J;if(k)if(M){if(B>0)g.height=A/B;if(n||n===0){g.y=n/B;g.height-=g.y}}else{g.height=A;if(n||n===0){g.height-=n;g.y=n}}else if(n||n===0){g.x+=g.width*(1-L);g.height=A}d=[{x:g.x,y:g.y},{x:g.x+g.width,y:g.y+g.height}];F=(x<=d[0].x&&d[0].x<=w||x<=d[1].x&&d[1].x<=w)&&(z<=d[0].y&&d[0].y<=y||z<=d[1].y&&d[1].y<=y);d[0].x=p(d[0].x,x,w);d[0].y=p(d[0].y,z,y);d[1].x=p(d[1].x,x,w);d[1].y=p(d[1].y,z,y);d=R(c,S,H,T,J,d);if(d[0].x>d[1].x){v=d[0].x;d[0].x=d[1].x;d[1].x=v}if(d[0].y>d[1].y){v=d[0].y;d[0].y=d[1].y;d[1].y=v}f={x:d[0].x,y:d[0].y,width:d[1].x-d[0].x,height:d[1].y-d[0].y};if(F){if(f.width===0)f.width=.5;if(f.height===0)f.height=.5}if(b.showChartLabels)s=P(f,A,N,K);j=r.r?r.r:b.clusterRadius;if(j)I=a.extend(true,{},r,{r:0});if(Q!=="none"&&m)m=parseInt(m,10);if(!m||isNaN(m))m=0;o=f.width-m;l=f.height-m;if(o<0)o=0;if(l<0)l=0;if(G){if(q===-1)if(c)q=C.x;else q=C.y+O-m;if(j){if(c){i=e.roundRect(f.x,f.y,o,l,0,0,j,j).hide();h=e.rect(q,f.y,0,l)}else{i=e.roundRect(f.x,f.y,o,l,j,0,0,j).hide();h=e.rect(f.x,q,f.width,0)}D(h,E);h.wijAttr(I);h.bar=i}else{if(c)i=e.rect(q,f.y,0,l);else i=e.rect(f.x,q,f.width,0);h=i}if(s){s.attr({opacity:0});h.chartLabel=s}h.left=f.x;h.top=f.y;h.width=o;h.height=l;h.r=j}else if(j)i=e.roundRect(f.x,f.y,o,l,0,0,j,j);else i=e.rect(f.x,f.y,o,l);D(i,E);if(G&&j)i.shadow&&i.shadow.hide();i.wijAttr(r);return{rect:f,dcl:s,animatedBar:h,bar:i}}function T(i,A,w,C,D,E,s,y,n,r){var f=b.clusterOverlap/100,z=b.clusterWidth/100,q=1,x=b.clusterSpacing+q,o=i.length,d,g,l=[],v=[],p=[],j=[],u=[],h=[],m=e.set();if(n||r){a.each(i,function(d,c){var b=a.extend(true,{},c);b.data&&b.data.y&&b.data.y.length&&n&&a.each(b.data.y,function(d,c){b.data.y[d]=a.toOADate(c)});b.data&&b.data.x&&b.data.x.length&&r&&a.each(b.data.x,function(d,c){b.data.x[d]=a.toOADate(c)});u.push(b)});d=B(u)}else d=B(i);if(k)d=V(d);g=W(d)*z;if(o>1&&!k){f-=d.length*(o-1)*x/(c?s:E);g/=o*(1-f)+f}a.each(d,function(e,u){var d=u.paSpec,x=d.length,o,r,c,b;if(k)o=g;else o=g*(x*(1-f)+f);r={x:u.x-o/2,y:0,width:g,height:d[0].y};a.each(d,function(g,z){if(!j[g])j[g]=[];if(!h[g])h[g]=[];var u=z.sIdx,x=A[u],o=i[u],k;b=X(r,z.y,s,C,D,x,I,q,y,f,g>0?d[g-1].y:null,d[d.length-1].y,n,o.textStyle);c=b.bar;k=c.clone().attr({opacity:.01,fill:"white","fill-opacity":.01});t(a(c.node),"wijchart-canvas-object wijbarchart");a(c.node).data("wijchartDataObj",a.extend(true,{index:e,bar:c,type:"bar",style:x,hoverStyle:w[u],x:o.data.x[e],y:o.data.y[e]},o));a(k.node).data("owner",a(c.node));t(a(k.node),"wijbarchart bartracker");b.bar.tracker=k;m.push(k);v.push(c);b.animatedBar&&p.push(b.animatedBar);b.dcl&&l.push(b.dcl);j[g][e]=b.rect;h[g][e]=b})});a.each(l,function(b,a){a.toFront()});m.toFront();return{bars:v,animatedBars:p,rects:j,chartLabels:l,seriesEles:h,trackers:m}}function U(k){var e=b.seriesTransition,g,i,j=[],d;if(I){g=q.duration||2e3;i=q.easing||"linear";a.each(k,function(f,b){var k=c?{width:b.width,x:b.left}:{height:b.height,y:b.top};if(h&&e.enabled)if(h.length>f){d=a.wijchart.getDiffAttrs(h[f],b.attr());if(c){d.x=h[f].x;d.width=h[f].width}else{d.y=h[f].y;d.height=h[f].height}if(d.path)delete d.path;b.attr(d);g=e.duration;i=e.easing}j.push(a.extend(true,{},b.attr(),k));b.tracker&&b.tracker.hide();b.stop().wijAnimate(k,g,i,function(){var a=this,c=a.r,b=a;a.chartLabel&&a.chartLabel.wijAnimate({opacity:1},250);if(a.tracker){a.tracker.show();a.tracker.attr({width:a.width,height:a.height,x:a.attr("x"),y:a.attr("y")})}if(c){b=a.bar;b.show();b.shadow&&b.shadow.show();if(a.shadow){a.shadow.wijRemove();a.shadow=null}a.wijRemove();a=null}})});f.aniBarsAttr=j}}function S(){var b=a.isFunction;L&&L.setTargets(n.bars);a(".wijbarchart",d[0]).live("mousedown."+i,function(f){if(j)return;if(b(F)){var c=a(f.target),e;if(c.data("owner"))c=c.data("owner");e=c.data("wijchartDataObj");F.call(d,f,e)}}).live("mouseup."+i,function(f){if(j)return;if(b(K)){var c=a(f.target),e;if(c.data("owner"))c=c.data("owner");e=c.data("wijchartDataObj");K.call(d,f,e)}}).live("mouseover."+i,function(f){if(j)return;if(b(H)){var c=a(f.target),e;if(c.data("owner"))c=c.data("owner");e=c.data("wijchartDataObj");H.call(d,f,e)}}).live("mouseout."+i,function(g){if(j)return;var e=a(g.target),c,f;if(e.data("owner"))e=e.data("owner");c=e.data("wijchartDataObj");f=c.bar;b(J)&&J.call(d,g,c);if(!c.hoverStyle)f&&f.attr({opacity:"1"});else f.attr(c.style)}).live("mousemove."+i,function(g){if(j)return;var e=a(g.target),c,f;if(e.data("owner"))e=e.data("owner");c=e.data("wijchartDataObj");f=c.bar;b(G)&&G.call(d,g,c);if(!c.hoverStyle)f&&f.attr({opacity:"0.8"});else f.attr(c.hoverStyle)}).live("click."+i,function(f){if(j)return;if(b(M)){var c=a(f.target),e;if(c.data("owner"))c=c.data("owner");e=c.data("wijchartDataObj");M.call(d,f,e)}})}function Q(){a(".wijbarchart",d[0]).die(i)}Q();if(c&&!k){s.reverse();C.reverse();z.reverse()}if(u===0)return;g=T(s,C,z,{min:l.min,max:l.max,late:N,scale:w},{min:m.min,max:m.max,late:O,scale:x},y,v,o,Z,Y);d.data("plotInfos",{xscale:w,xlate:N,yscale:x,ylate:O,rects:g.rects});U(g.animatedBars);n.bars=g.bars;n.animatedBars=g.animatedBars;n.chartLabels=g.chartLabels;f.seriesEles=g.seriesEles;f.trackers=g.trackers;if(!f.chartElements)f.chartElements={};c&&!k&&f.seriesEles.reverse();a.extend(true,f.chartElements,n);d.data("fields",f);S()}})})(jQuery);